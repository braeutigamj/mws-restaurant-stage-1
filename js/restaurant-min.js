!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?exports.Restaurant=e():t.Restaurant=e()}("undefined"!=typeof self?self:this,function(){return function(t){var e={};function n(r){if(e[r])return e[r].exports;var o=e[r]={i:r,l:!1,exports:{}};return t[r].call(o.exports,o,o.exports,n),o.l=!0,o.exports}return n.m=t,n.c=e,n.d=function(t,e,r){n.o(t,e)||Object.defineProperty(t,e,{configurable:!1,enumerable:!0,get:r})},n.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return n.d(e,"a",e),e},n.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},n.p="",n(n.s=0)}([function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),n.d(e,"Restaurant",function(){return a});var r=n(1),o=this&&this.__awaiter||function(t,e,n,r){return new(n||(n=Promise))(function(o,i){function a(t){try{s(r.next(t))}catch(t){i(t)}}function u(t){try{s(r.throw(t))}catch(t){i(t)}}function s(t){t.done?o(t.value):new n(function(e){e(t.value)}).then(a,u)}s((r=r.apply(t,e||[])).next())})},i=this&&this.__generator||function(t,e){var n,r,o,i,a={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:u(0),throw:u(1),return:u(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function u(i){return function(u){return function(i){if(n)throw new TypeError("Generator is already executing.");for(;a;)try{if(n=1,r&&(o=2&i[0]?r.return:i[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,i[1])).done)return o;switch(r=0,o&&(i=[2&i[0],o.value]),i[0]){case 0:case 1:o=i;break;case 4:return a.label++,{value:i[1],done:!1};case 5:a.label++,r=i[1],i=[0];continue;case 7:i=a.ops.pop(),a.trys.pop();continue;default:if(!(o=(o=a.trys).length>0&&o[o.length-1])&&(6===i[0]||2===i[0])){a=0;continue}if(3===i[0]&&(!o||i[1]>o[0]&&i[1]<o[3])){a.label=i[1];break}if(6===i[0]&&a.label<o[1]){a.label=o[1],o=i;break}if(o&&a.label<o[2]){a.label=o[2],a.ops.push(i);break}o[2]&&a.ops.pop(),a.trys.pop();continue}i=e.call(t,a)}catch(t){i=[6,t],r=0}finally{n=o=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,u])}}},a=function(){function t(){this.dbManager=new r.a,this.loadRestaurant()}return t.prototype.loadRestaurant=function(){return o(this,void 0,void 0,function(){var t,e;return i(this,function(n){switch(n.label){case 0:return(t=parseInt(this.getParameterByName("id"),10))?(e=this,[4,this.dbManager.getRestaurantDetail(t)]):(console.error("No restaurant id in URL"),[2]);case 1:return e.restaurant=n.sent(),addMarkersToMap([this.restaurant]),this.fillRestaurantHTML(),this.fillBreadcrumb(),[2]}})})},t.prototype.getParameterByName=function(t,e){e||(e=location.href),t=t.replace(/[\[\]]/g,"\\$&");var n=new RegExp("[?&]"+t+"(=([^&#]*)|&|#|$)").exec(e);return n?n[2]?decodeURIComponent(n[2].replace(/\+/g," ")):"":null},t.prototype.fillRestaurantHTML=function(){return o(this,void 0,void 0,function(){var e,n,r,o;return i(this,function(i){switch(i.label){case 0:return e=document.getElementById("restaurant-name"),n=e,r=this.restaurant.name,[4,this.getFavouriteStar()];case 1:return n.innerHTML=r+i.sent(),e.addEventListener("click",this.changeFavouriteState.bind(this)),document.getElementById("restaurant-address").innerHTML=this.restaurant.address,(o=document.getElementById("restaurant-img")).className="restaurant-img",o.src="/img/"+this.restaurant.photograph,o.srcset=t.getRestaurantSrcset(this.restaurant.photograph),o.alt="photograph of "+this.restaurant.name,document.getElementById("restaurant-cuisine").innerHTML=this.restaurant.cuisine_type,this.restaurant.operating_hours&&this.fillRestaurantHoursHTML(),this.fillReviewsHTML(),[2]}})})},t.prototype.changeFavouriteState=function(t){return o(this,void 0,void 0,function(){return i(this,function(t){switch(t.label){case 0:return[4,this.dbManager.changeFavouriteState(this.restaurant.id)];case 1:return t.sent(),this.fillRestaurantHTML(),[2]}})})},t.prototype.getFavouriteStar=function(){return o(this,void 0,void 0,function(){var t;return i(this,function(e){switch(e.label){case 0:return t=' <a href="#" id="favourite" aria-label="',[4,this.dbManager.isFavouriteRestaurant(this.restaurant.id)];case 1:return e.sent()?t+='unset favourite"> &#9733;':t+='set favourite"> &#9734;',[2,t+"</a>"]}})})},t.prototype.fillRestaurantHoursHTML=function(){var t=document.getElementById("restaurant-hours");for(var e in t.innerHTML="",this.restaurant.operating_hours){var n=document.createElement("tr"),r=document.createElement("td");r.innerHTML=e,n.appendChild(r);var o=document.createElement("td");o.innerHTML=this.restaurant.operating_hours[e],n.appendChild(o),t.appendChild(n)}},t.prototype.fillReviewsHTML=function(){return o(this,void 0,void 0,function(){var t,e,n,r,o,a,u=this;return i(this,function(i){switch(i.label){case 0:return(t=document.getElementById("reviews-container")).innerHTML="",(e=document.createElement("h3")).setAttribute("tabindex","0"),e.innerHTML="Reviews",t.appendChild(e),(n=document.createElement("div")).innerHTML='\n      <div class="form_review">\n          <label for="form_name">Your Name:</label>\n          <input type="text" id="form_name" />\n          <label for="form_rating">Your Rating:</label>\n          <select id="form_rating">\n            <option value="1">1 Star</option>\n            <option value="2">2 Stars</option>\n            <option value="3">3 Stars</option>\n            <option value="4">4 Stars</option>\n            <option value="5">5 Stars</option>\n          </select>\n          <label for="form_review">Your Message:</label>\n          <textarea id="form_review"></textarea>\n          <input type="submit" value="Send Review" id="form_submit"\n                 aria-label="Send Review" />\n      </div>\n    ',t.appendChild(n),document.getElementById("form_submit").addEventListener("click",this.formSubmit.bind(this)),[4,this.dbManager.getReviewsByRestaurantId(this.restaurant.id)];case 1:return(r=i.sent()).length?((a=document.createElement("ul")).setAttribute("id","reviews-list"),r.forEach(function(t){a.appendChild(u.createReviewHTML(t))}),t.appendChild(a),[2]):((o=document.createElement("p")).innerHTML="No reviews yet!",t.appendChild(o),[2])}})})},t.prototype.formSubmit=function(t){this.dbManager.addReviewByRestaurant(this.restaurant.id,document.getElementById("form_name").value,parseInt(document.getElementById("form_rating").value,10),document.getElementById("form_review").value),document.getElementById("form_name").value="",document.getElementById("form_rating").value="",document.getElementById("form_review").value="",this.fillReviewsHTML()},t.prototype.createReviewHTML=function(t){var e=document.createElement("li"),n=document.createElement("div");n.classList.add("review-head");var r=document.createElement("span");r.classList.add("review-name"),r.innerHTML=t.name,n.appendChild(r);var o=document.createElement("span");o.classList.add("review-date"),o.innerHTML=new Date(t.updatedAt).toString(),n.appendChild(o),e.appendChild(n);var i=document.createElement("p");i.classList.add("review-rating"),i.innerHTML="Rating: "+t.rating,e.appendChild(i);var a=document.createElement("p");return a.innerHTML=t.comments,e.appendChild(a),e},t.prototype.fillBreadcrumb=function(){var t=document.querySelector("#breadcrumb ul"),e=document.createElement("li"),n=document.createElement("a");n.innerHTML=this.restaurant.name,n.setAttribute("aria-current","page"),n.href="#",e.appendChild(n),t.appendChild(e)},t.getRestaurantSrcset=function(t){var e="";return[200,300,600].forEach(function(n){e+="/img/"+n+"/"+t+" "+n+"w,"}),e.slice(0,-1)},t.urlForRestaurant=function(t){return"./restaurant.html?id="+t.id},t}()},function(t,e,n){"use strict";n.d(e,"a",function(){return a});var r=n(2),o=(n.n(r),this&&this.__awaiter||function(t,e,n,r){return new(n||(n=Promise))(function(o,i){function a(t){try{s(r.next(t))}catch(t){i(t)}}function u(t){try{s(r.throw(t))}catch(t){i(t)}}function s(t){t.done?o(t.value):new n(function(e){e(t.value)}).then(a,u)}s((r=r.apply(t,e||[])).next())})}),i=this&&this.__generator||function(t,e){var n,r,o,i,a={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:u(0),throw:u(1),return:u(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function u(i){return function(u){return function(i){if(n)throw new TypeError("Generator is already executing.");for(;a;)try{if(n=1,r&&(o=2&i[0]?r.return:i[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,i[1])).done)return o;switch(r=0,o&&(i=[2&i[0],o.value]),i[0]){case 0:case 1:o=i;break;case 4:return a.label++,{value:i[1],done:!1};case 5:a.label++,r=i[1],i=[0];continue;case 7:i=a.ops.pop(),a.trys.pop();continue;default:if(!(o=(o=a.trys).length>0&&o[o.length-1])&&(6===i[0]||2===i[0])){a=0;continue}if(3===i[0]&&(!o||i[1]>o[0]&&i[1]<o[3])){a.label=i[1];break}if(6===i[0]&&a.label<o[1]){a.label=o[1],o=i;break}if(o&&a.label<o[2]){a.label=o[2],a.ops.push(i);break}o[2]&&a.ops.pop(),a.trys.pop();continue}i=e.call(t,a)}catch(t){i=[6,t],r=0}finally{n=o=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,u])}}},a=function(){function t(){this.refreshDB(),this.dbPromise=r.open("restaurantApp",3,this.updateDBStructure),this.retryPendingReviewRequests()}return t.prototype.refreshDB=function(){return o(this,void 0,void 0,function(){var t=this;return i(this,function(e){switch(e.label){case 0:return[4,this.fetchRestaurants()];case 1:return e.sent().forEach(function(e){t.dbPromise.then(function(n){var r=n.transaction("restaurant","readwrite").objectStore("restaurant");t.fetchReviewsByRestaurant(e.id).then(function(r){r&&(t.clearDB("review",e.id),r.forEach(function(t){t.restaurantId=e.id,n.transaction("review","readwrite").objectStore("review").put(t)}))}),r.put(e)})}),[2]}})})},t.prototype.clearDB=function(t,e){this.dbPromise.then(function(n){var r=n.transaction(t,"readwrite").objectStore(t);if(e){var o="restaurantId";"restaurant"===t&&(o="id"),r.index(o).getAllKeys(e).then(function(t){r.delete(t)})}else r.clear()})},t.prototype.updateDBStructure=function(t){switch(t.oldVersion){case 0:t.createObjectStore("restaurant",{keyPath:"id"}).createIndex("id","id",{unique:!1}),t.createObjectStore("review",{keyPath:"rid",autoIncrement:!0}).createIndex("restaurantId","restaurantId",{unique:!1});case 1:t.createObjectStore("pendingReviewRequests",{keyPath:"pid",autoIncrement:!0});case 2:t.createObjectStore("favourite")}},t.prototype.fetchRestaurants=function(){return o(this,void 0,void 0,function(){var e=this;return i(this,function(n){return[2,this.fetchData(t.DATABASE_URL+"restaurants").then(function(t){return e.clearDB("restaurant"),e.checkForMissingPhotograph(t)})]})})},t.prototype.fetchReviewsByRestaurant=function(e){return o(this,void 0,void 0,function(){return i(this,function(n){switch(n.label){case 0:return[4,this.fetchData(t.DATABASE_URL+"reviews/?restaurant_id="+e)];case 1:return[2,n.sent()]}})})},t.prototype.fetchData=function(t){return o(this,void 0,void 0,function(){return i(this,function(e){return[2,new Promise(function(e,n){var r=new XMLHttpRequest;r.open("GET",t),r.onload=function(){if(200===r.status){var t=JSON.parse(r.responseText);e(t)}else n(),console.log("\n                  Failed to connect to database! Failfurecode: Request failed.\n                  Returned status of "+r.status);e([])},r.send()})]})})},t.prototype.checkForMissingPhotograph=function(t){return t.forEach(function(t){t.photograph||(t.photograph=t.id.toString()),t.photograph.toString().match(/.*jpg/)||(t.photograph+=".jpg")}),t},t.prototype.getAllNeighborhoods=function(){return o(this,void 0,void 0,function(){var t,e;return i(this,function(n){switch(n.label){case 0:return[4,this.getAllRestaurantDetails()];case 1:return t=n.sent(),e=[],t.forEach(function(t){e.includes(t.neighborhood)||e.push(t.neighborhood)}),[2,e]}})})},t.prototype.getAllCuisines=function(){return o(this,void 0,void 0,function(){var t,e;return i(this,function(n){switch(n.label){case 0:return[4,this.getAllRestaurantDetails()];case 1:return t=n.sent(),e=[],t.forEach(function(t){e.includes(t.cuisine_type)||e.push(t.cuisine_type)}),[2,e]}})})},t.prototype.getRestaurantDetail=function(t){return o(this,void 0,void 0,function(){var e=this;return i(this,function(n){return[2,new Promise(function(n){e.dbPromise.then(function(e){e.transaction("restaurant").objectStore("restaurant").index("id").get(t).then(function(t){n(t)})})})]})})},t.prototype.getRestaurantsDetails=function(t,e){return o(this,void 0,void 0,function(){var n,r;return i(this,function(o){switch(o.label){case 0:return[4,this.getAllRestaurantDetails()];case 1:return n=o.sent(),r=[],n.forEach(function(n){n.neighborhood!=t&&"all"!=t||n.cuisine_type!=e&&"all"!=e||r.push(n)}),[2,r]}})})},t.prototype.getAllRestaurantDetails=function(){return o(this,void 0,void 0,function(){var t=this;return i(this,function(e){return[2,new Promise(function(e){t.dbPromise.then(function(t){t.transaction("restaurant").objectStore("restaurant").getAll().then(function(t){e(t)})})})]})})},t.prototype.getReviewsByRestaurantId=function(t){return o(this,void 0,void 0,function(){var e=this;return i(this,function(n){return[2,new Promise(function(n){e.dbPromise.then(function(e){e.transaction("review").objectStore("review").index("restaurantId").getAll(t).then(function(t){n(t.reverse())})})})]})})},t.prototype.addReviewByRestaurant=function(t,e,n,r){this.dbPromise.then(function(o){o.transaction("review","readwrite").objectStore("review").put({restaurantId:t,restuarant_id:t,name:e,createdAt:Date.now(),updatedAt:Date.now(),rating:n,comments:r})}),this.sendReview({restaurant_id:t,name:e,rating:n,comments:r})},t.prototype.sendReview=function(e){var n=this,r=new XMLHttpRequest;r.open("POST",t.DATABASE_URL+"reviews/",!0),r.setRequestHeader("Content-Type","application/json"),r.onreadystatechange=function(){4!=r.readyState||200===r.status&&201===r.status||n.addToPendingReviewRequests(e)},r.onerror=function(){n.addToPendingReviewRequests(e)},r.send(JSON.stringify(e))},t.prototype.addToPendingReviewRequests=function(t){this.dbPromise.then(function(e){e.transaction("pendingReviewRequests","readwrite").objectStore("pendingReviewRequests").put(t)})},t.prototype.retryPendingReviewRequests=function(){var t=this;this.dbPromise.then(function(e){e.transaction("pendingReviewRequests").objectStore("pendingReviewRequests").getAll().then(function(n){e.transaction("pendingReviewRequests","readwrite").objectStore("pendingReviewRequests").clear(),n.forEach(function(e){return t.sendReview(e)})})}),window.setTimeout(this.retryPendingReviewRequests.bind(this),3e3)},t.prototype.isFavouriteRestaurant=function(t){return this.dbPromise.then(function(e){return e.transaction("favourite").objectStore("favourite").get(t)})},t.prototype.changeFavouriteState=function(t){return o(this,void 0,void 0,function(){var e=this;return i(this,function(n){switch(n.label){case 0:return[4,this.dbPromise.then(function(n){return n.transaction("favourite").objectStore("favourite").get(t).then(function(n){e.dbPromise.then(function(e){n?e.transaction("favourite","readwrite").objectStore("favourite").put(!1,t):e.transaction("favourite","readwrite").objectStore("favourite").put(!0,t)})})})];case 1:return n.sent(),[2]}})})},t.DATABASE_URL="https://pure-dusk-67754.herokuapp.com/",t}()},function(t,e,n){"use strict";!function(){function e(t){return new Promise(function(e,n){t.onsuccess=function(){e(t.result)},t.onerror=function(){n(t.error)}})}function n(t,n,r){var o,i=new Promise(function(i,a){e(o=t[n].apply(t,r)).then(i,a)});return i.request=o,i}function r(t,e,n){n.forEach(function(n){Object.defineProperty(t.prototype,n,{get:function(){return this[e][n]},set:function(t){this[e][n]=t}})})}function o(t,e,r,o){o.forEach(function(o){o in r.prototype&&(t.prototype[o]=function(){return n(this[e],o,arguments)})})}function i(t,e,n,r){r.forEach(function(r){r in n.prototype&&(t.prototype[r]=function(){return this[e][r].apply(this[e],arguments)})})}function a(t,e,r,o){o.forEach(function(o){o in r.prototype&&(t.prototype[o]=function(){return t=this[e],(r=n(t,o,arguments)).then(function(t){if(t)return new s(t,r.request)});var t,r})})}function u(t){this._index=t}function s(t,e){this._cursor=t,this._request=e}function c(t){this._store=t}function d(t){this._tx=t,this.complete=new Promise(function(e,n){t.oncomplete=function(){e()},t.onerror=function(){n(t.error)},t.onabort=function(){n(t.error)}})}function l(t,e,n){this._db=t,this.oldVersion=e,this.transaction=new d(n)}function f(t){this._db=t}r(u,"_index",["name","keyPath","multiEntry","unique"]),o(u,"_index",IDBIndex,["get","getKey","getAll","getAllKeys","count"]),a(u,"_index",IDBIndex,["openCursor","openKeyCursor"]),r(s,"_cursor",["direction","key","primaryKey","value"]),o(s,"_cursor",IDBCursor,["update","delete"]),["advance","continue","continuePrimaryKey"].forEach(function(t){t in IDBCursor.prototype&&(s.prototype[t]=function(){var n=this,r=arguments;return Promise.resolve().then(function(){return n._cursor[t].apply(n._cursor,r),e(n._request).then(function(t){if(t)return new s(t,n._request)})})})}),c.prototype.createIndex=function(){return new u(this._store.createIndex.apply(this._store,arguments))},c.prototype.index=function(){return new u(this._store.index.apply(this._store,arguments))},r(c,"_store",["name","keyPath","indexNames","autoIncrement"]),o(c,"_store",IDBObjectStore,["put","add","delete","clear","get","getAll","getKey","getAllKeys","count"]),a(c,"_store",IDBObjectStore,["openCursor","openKeyCursor"]),i(c,"_store",IDBObjectStore,["deleteIndex"]),d.prototype.objectStore=function(){return new c(this._tx.objectStore.apply(this._tx,arguments))},r(d,"_tx",["objectStoreNames","mode"]),i(d,"_tx",IDBTransaction,["abort"]),l.prototype.createObjectStore=function(){return new c(this._db.createObjectStore.apply(this._db,arguments))},r(l,"_db",["name","version","objectStoreNames"]),i(l,"_db",IDBDatabase,["deleteObjectStore","close"]),f.prototype.transaction=function(){return new d(this._db.transaction.apply(this._db,arguments))},r(f,"_db",["name","version","objectStoreNames"]),i(f,"_db",IDBDatabase,["close"]),["openCursor","openKeyCursor"].forEach(function(t){[c,u].forEach(function(e){t in e.prototype&&(e.prototype[t.replace("open","iterate")]=function(){var e,n=(e=arguments,Array.prototype.slice.call(e)),r=n[n.length-1],o=this._store||this._index,i=o[t].apply(o,n.slice(0,-1));i.onsuccess=function(){r(i.result)}})})}),[u,c].forEach(function(t){t.prototype.getAll||(t.prototype.getAll=function(t,e){var n=this,r=[];return new Promise(function(o){n.iterateCursor(t,function(t){t?(r.push(t.value),void 0===e||r.length!=e?t.continue():o(r)):o(r)})})})});var p={open:function(t,e,r){var o=n(indexedDB,"open",[t,e]),i=o.request;return i&&(i.onupgradeneeded=function(t){r&&r(new l(i.result,t.oldVersion,i.transaction))}),o.then(function(t){return new f(t)})},delete:function(t){return n(indexedDB,"deleteDatabase",[t])}};t.exports=p,t.exports.default=t.exports}()}])});